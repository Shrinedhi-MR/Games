<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle Game Hub - All Levels in One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* -------- Global / Theme -------- */
    * { box-sizing: border-box; }
    html, body { height: 100%; scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #131a26, #1a2332 45%, #2d3748 100%);
      color: #e6f7ff;
      overflow-x: hidden;
    }

    .screen {
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: opacity .35s ease, transform .35s ease, visibility .35s ease;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
    }
    .screen.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    h1, h2, h3 {
      margin: 0 0 12px 0;
      line-height: 1.2;
    }
    .title {
      text-align: center;
      margin-top: 18px;
      margin-bottom: 6px;
      font-size: 2.2rem;
      background: linear-gradient(45deg, #00ff88, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
              background-clip: text;
    }
    .subtitle {
      text-align: center;
      margin: 0 0 28px 0;
      color: #b9d7ff;
      opacity: .9;
    }

    /* -------- Buttons -------- */
    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      padding: 14px 26px;
      border-radius: 12px;
      background: radial-gradient(120% 120% at 50% 0%, #0ff 0%, #0f8 45%, #07c 100%);
      color: #051018;
      font-weight: 700;
      letter-spacing: .3px;
      box-shadow: 0 10px 28px rgba(0,255,200,.18), inset 0 0 0 1px rgba(0,0,0,.12);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      will-change: transform;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 34px rgba(0,255,200,.24), inset 0 0 0 1px rgba(0,0,0,.1);
      filter: brightness(1.06);
    }
    .btn:active {
      transform: translateY(0);
      filter: brightness(.98);
    }
    .btn.secondary {
      background: linear-gradient(135deg, #3b82f6, #22d3ee);
      color: #08131a;
    }
    .btn.ghost {
      background: transparent;
      color: #a6e8ff;
      border: 1px solid rgba(166,232,255,.35);
      box-shadow: none;
    }
    .btn.ghost:hover {
      border-color: rgba(166,232,255,.75);
    }
    .btn.inline {
      padding: 10px 18px;
      border-radius: 22px;
      font-size: .95rem;
    }
    .btn:disabled {
      background: linear-gradient(135deg, #3a3f46, #2a2f36);
      color: #7c8793;
      cursor: not-allowed;
      box-shadow: none;
      filter: none;
      transform: none;
    }
    .glow {
      animation: glowPulse 1.6s ease-in-out infinite;
    }
    @keyframes glowPulse {
      0%   { box-shadow: 0 0 0 rgba(0,255,200,.0); }
      50%  { box-shadow: 0 0 18px rgba(0,255,200,.35); }
      100% { box-shadow: 0 0 0 rgba(0,255,200,.0); }
    }
    .pulse {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* -------- Hub -------- */
    .hub-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      margin: 22px auto 12px auto;
      max-width: 1000px;
    }
    .level-card {
      background: rgba(0, 0, 0, .35);
      border: 1px solid rgba(0, 255, 200, .15);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .level-card:hover {
      transform: translateY(-2px);
      border-color: rgba(0, 255, 200, .35);
      box-shadow: 0 16px 34px rgba(0,0,0,.32);
    }
    .level-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #a7f3d0;
    }
    .level-desc {
      color: #b9d7ff;
      opacity: .9;
      font-size: .95rem;
      margin-bottom: 12px;
      min-height: 38px;
    }

    /* -------- Layout controls -------- */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin: 8px 0 18px 0;
      position: sticky; top: 0; z-index: 50;
      background: linear-gradient(135deg, rgba(19,26,38,.85), rgba(26,35,50,.85));
      backdrop-filter: blur(6px);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,255,200,.18);
    }
    .spacer { height: 8px; }

    .cta-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 16px;
    }

    .panel {
      background: rgba(0, 0, 0, .35);
      border: 1px solid rgba(0, 255, 200, .15);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }

    /* -------- Level 1: Matrix Security System -------- */
    .l1-wrap .grid {
      display: grid;
      grid-template-columns: repeat(3, 64px);
      gap: 6px;
      margin: 14px auto;
      background: rgba(0,0,0,.45);
      padding: 10px;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 136, 0.3);
      width: max-content;
    }
    .l1-wrap .cell {
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 136, 0.35);
      color: #00ff88;
      background: rgba(255,255,255,.06);
      cursor: pointer;
      transition: transform .18s ease, background .18s ease;
    }
    .l1-wrap .cell:hover { transform: scale(1.05); background: rgba(0,255,136,.16); }
    .l1-wrap .cell.pre { background: rgba(255, 107, 107, 0.25); color: #ff6b6b; cursor: not-allowed; }
    .l1-wrap .cell.placed { background: rgba(0,255,136,.22); color: #00ff88; }
    .l1-note { color: #b9d7ff; opacity: .9; text-align: center; }

    /* -------- Level 2: Security Breach Grid -------- */
    .l2-grid {
      display: grid;
      grid-template-columns: repeat(6, 52px);
      grid-template-rows: repeat(5, 52px);
      gap: 4px;
      margin: 16px auto;
      background: #000;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #ff6600;
      width: max-content;
      user-select: none;
    }
    .l2-cell {
      width: 52px; height: 52px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      font-weight: 800; font-size: 18px;
      color: #fff;
    }
    .l2-cell.letter { background: linear-gradient(135deg, #ff4444, #cc2222); border-color: #ff6666; box-shadow: 0 0 14px rgba(255, 68, 68, .6); }
    .l2-cell.connected { background: linear-gradient(135deg, #00ff88, #00cc66); border-color: #00ff88; color: #041; }
    .l2-cell.current { animation: pulse 1s infinite; }

    /* -------- Level 3: Audio Decoder -------- */
    .l3-audio {
      display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    .l3-audio audio { width: 320px; max-width: 86vw; }

    /* -------- Level 4: Code Cracking (full) -------- */
    .l4-wrap .lock-display { text-align: center; margin: 24px 0; }
    .l4-wrap .lock-icon { font-size: 3rem; color: #ffd700; text-shadow: 0 0 18px rgba(255,215,0,.35); margin-bottom: 10px; }
    .l4-wrap .code-slots { display: flex; justify-content: center; gap: 12px; margin: 16px 0; }
    .l4-wrap .code-slot { width: 72px; height: 72px; background: rgba(255,255,255,.08); border: 3px solid rgba(255,215,0,.55); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 800; color: #ffd700; font-family: 'Courier New', monospace; }
    .l4-wrap .clue-section { background: rgba(0,0,0,.35); border-radius: 12px; padding: 18px; margin: 18px 0; border: 1px solid rgba(0,255,136,.18); }
    .l4-wrap .clue-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 10px 0; padding: 10px; background: rgba(255,255,255,.04); border-left: 4px solid rgba(0,212,255,.45); border-radius: 8px; }
    .l4-wrap .clue-numbers { display: flex; gap: 8px; }
    .l4-wrap .clue-digit { width: 46px; height: 46px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: rgba(0,212,255,.18); border: 2px solid rgba(0,212,255,.45); color: #00d4ff; font-size: 20px; font-weight: 800; font-family: 'Courier New', monospace; }
    .l4-wrap .clue-text { color: #cfe8ff; opacity: .95; }
    .l4-wrap .code-input { background: rgba(0,0,0,.6); border: 3px solid #00d4ff; border-radius: 12px; padding: 16px; color: #00d4ff; font-size: 28px; text-align: center; width: 180px; letter-spacing: 10px; font-weight: 800; font-family: 'Courier New', monospace; }
    .l4-wrap .warning { display: none; background: rgba(255, 107, 107, .14); border: 1px solid #ff6b6b; color: #ff8585; padding: 12px 14px; border-radius: 10px; text-align: center; }
    .l4-wrap .success { display: none; background: rgba(0,255,136,.14); border: 1px solid #00ff88; color: #00ff88; padding: 16px; border-radius: 12px; text-align: center; }
    .l4-wrap .attempts { text-align: center; color: #b9d7ff; }

    /* -------- Level 5: Cross Number Puzzle (full) -------- */
    .l5-crosses {
      display: flex; gap: 26px; flex-wrap: wrap; justify-content: center; margin: 12px 0 18px 0;
    }
    .l5-cross {
      display: grid;
      grid-template-areas:
        ". t ."
        "l c r"
        ". b .";
      grid-template-columns: 58px 58px 58px;
      grid-template-rows: 58px 58px 58px;
      gap: 4px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(0, 212, 255, .35);
      background: rgba(0,0,0,.4);
    }
    .l5-cell {
      display: flex; align-items: center; justify-content: center;
      background: rgba(0, 212, 255, .12);
      border: 1px solid rgba(0, 212, 255, .35);
      border-radius: 8px;
      color: #00d4ff; font-weight: 700;
    }
    .l5-cell.t { grid-area: t; }
    .l5-cell.l { grid-area: l; }
    .l5-cell.c { grid-area: c; }
    .l5-cell.r { grid-area: r; }
    .l5-cell.b { grid-area: b; }
    .l5-cell.input { background: rgba(255,215,0,.12); border-color: #ffd700; color: #ffd700; cursor: pointer; }
    .l5-note { text-align: center; color: #b9d7ff; }
    .l5-number-input { background: rgba(0,0,0,.6); border: 2px solid #ffd700; border-radius: 8px; padding: 10px; color: #ffd700; font-weight: 800; text-align: center; width: 90px; font-family: 'Courier New', monospace; }

    /* -------- Level 6: Security Access Terminal -------- */
    .l6-panel .code {
      width: 200px; text-align: center;
      padding: 14px; border-radius: 10px;
      border: 3px solid #ffd700; background: rgba(0,0,0,.55);
      color: #ffd700; letter-spacing: 3px; font-size: 1.25rem; font-weight: 700;
      font-family: Consolas, 'Courier New', monospace;
    }
    .l6-directive-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin: 16px 0 24px 0; }
    .l6-panelBox { background: rgba(0,0,0,.4); border: 2px solid rgba(0,212,255,.3); border-radius: 12px; padding: 14px; text-align: center; }
    .l6-panelId { color: #00d4ff; font-weight: 800; margin-bottom: 10px; letter-spacing: 2px; }
    .l6-seq { display: flex; justify-content: center; gap: 8px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,.5); border: 1px solid rgba(0,212,255,.2); }
    .l6-cmd { font-size: 1.8rem; color: #00d4ff; font-weight: 800; }
    .l6-hint { text-align: center; color: #ffd700; background: rgba(255,215,0,.08); border: 1px solid rgba(255,215,0,.35); border-radius: 10px; padding: 12px; margin-top: 10px; }
    .msg-ok { background: rgba(0,255,136,.14); border: 1px solid #00ff88; color: #00ff88; padding: 12px 14px; border-radius: 10px; }
    .msg-bad { background: rgba(255, 107, 107, .14); border: 1px solid #ff6b6b; color: #ff8585; padding: 12px 14px; border-radius: 10px; }

    /* Utility */
    .muted { color: #b9d7ff; opacity: .9; }
    .center { text-align: center; }
    .field { margin: 10px 0; }
    .stack { display: flex; flex-direction: column; gap: 12px; align-items: center; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: center; }
    .hidden { display: none !important; }

    /* -------- Intro / Final screens -------- */
    .hero {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 14px; min-height: 60vh; text-align: center;
    }
    .hero h1 { font-size: 2.4rem; }
    .hero p { max-width: 720px; color: #cfe8ff; }
    .badge {
      display: inline-block; padding: 6px 12px; border-radius: 999px; font-weight: 700;
      background: rgba(0,255,136,.12); border: 1px solid rgba(0,255,136,.35); color: #00ff88;
    }
    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 14px 0;
    }
    .stat {
      background: rgba(0,0,0,.35); border: 1px solid rgba(0,255,200,.18); border-radius: 12px; padding: 14px; text-align: center;
    }

    /* -------- Floating mission timer -------- */
    .timer-badge {
      position: fixed; top: 10px; right: 10px; z-index: 9999;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(0,255,200,.35);
      color: #a7f3d0;
      padding: 8px 12px; border-radius: 999px;
      font-weight: 700; letter-spacing: .5px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display: none;
    }
  </style>
</head>
<body>
  <div id="missionTimer" class="timer-badge">⏱️ 00:00</div>
  <!-- INTRO -->
  <section id="intro" class="screen active">
    <div class="hero">
      <span class="badge">ALERT • CYBER INCIDENT</span>

      <h1 class="title">ESCAPE ROOM: SYSTEM RESTORE</h1>

<div class="company-logo" style="font-size: 2.1rem; text-align: center; margin-bottom: 6px; user-select: none; letter-spacing:1px;">
  🏢
</div>
<div class="story-title" style="font-size: 2.1rem; font-family: 'Orbitron','Segoe UI',sans-serif; font-weight: 700; color: #00ecb3; text-align: center; margin-bottom: 4px; letter-spacing: 2px;">
  CORPORATE CRISIS
</div>
<div class="story-subtitle" style="font-size: 1.13rem; font-family:'Segoe UI',sans-serif; color: #aafff3; text-align:center; margin-bottom: 20px; letter-spacing: 1.2px;">
  System Breach Protocol
</div>

<div class="crisis-alert" style="background: #1a0010; border: 2px solid #ff4747; box-shadow: 0 0 16px 2px #ff474777; color: #ffeaea; border-radius: 10px; font-size: 1.1rem; font-family: 'Segoe UI',sans-serif; font-weight: 600; text-align: center; padding: 18px 16px 13px 16px; margin: 14px auto 25px auto; max-width: 620px; letter-spacing:0.03em;">
  🚨 <span style="color:#ff4747; font-weight:700;">CRITICAL ALERT: MULTIPLE SYSTEM FAILURES DETECTED!</span> 🚨<br>
  <span style="font-weight: 500;">All departments require immediate intervention to restore operations!</span>
</div>

<div class="story-content" style="background:#172332; border:1.7px solid #00b6ff; border-radius:14px; box-shadow:0 0 18px 1px #00b6ffaa; color: #fafcff; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 680px; margin:32px auto 0 auto; padding: 28px 30px 22px 30px;">
  <h3 style="color: #00d4ff; margin-bottom: 20px; font-size: 1.32rem; font-weight: bold; letter-spacing: 0.04em; text-align:center;">
    📋 SITUATION BRIEFING
  </h3>
  <p style="margin-bottom: 15px; font-size: 1.08rem; line-height: 1.5; text-align: center;">
    Your company is experiencing a coordinated cyber attack that has compromised multiple critical systems. As the emergency response team, you must work together to:
  </p>
  <ul style="margin: 20px 0; padding-left: 32px; color: #dadada; font-size: 1.02rem; line-height:1.7; text-align: left;">
    <li>Navigate through each compromised department</li>
    <li>Solve security puzzles to unlock systems</li>
    <li>Collect access codes and restore operations</li>
    <li>Complete all missions before the backup systems fail</li>
  </ul>
  <p style="color: #ff6b6b; font-weight: bold; text-align: center; margin-top: 25px; font-size: 1.08rem;">
    ⚡ Time is critical - coordinate with your team to succeed!
  </p>
</div>



      <p class="subtitle"></p>
      
      
      <div class="row">
        <button class="btn" onclick="beginEmergency()">🚨 Begin Emergency</button>
      </div>
    </div>
  </section>
  <!-- HUB -->
  <section id="hub" class="screen">
    <h1 class="title">🕹️ Puzzle Game Hub</h1>
    <p class="subtitle">Solve each level to unlock the next. Progress is saved automatically.</p>

    <div class="hub-grid">
      <div class="level-card">
        <div class="level-title">Level 1 — Matrix Security System</div>
        <div class="level-desc"></div>
        <button id="btnLevel1" class="btn glow" onclick="openLevel(1)">Start Level 1</button>
      </div>

      <div class="level-card">
        <div class="level-title">Level 2 — Security Breach Grid</div>
        <div class="level-desc"></div>
        <button id="btnLevel2" class="btn" onclick="openLevel(2)" disabled>Level 2</button>
      </div>

      <div class="level-card">
        <div class="level-title">Level 3 — Audio Decoder</div>
        <div class="level-desc"></div>
        <button id="btnLevel3" class="btn" onclick="openLevel(3)" disabled>Level 3</button>
      </div>

      <div class="level-card">
        <div class="level-title">Level 4 — Code Cracking</div>
        <div class="level-desc"></div>
        <button id="btnLevel4" class="btn" onclick="openLevel(4)" disabled>Level 4</button>
      </div>

      <div class="level-card">
        <div class="level-title">Level 5 — Cross Number</div>
        <div class="level-desc"></div>
        <button id="btnLevel5" class="btn" onclick="openLevel(5)" disabled>Level 5</button>
      </div>

      <div class="level-card">
        <div class="level-title">Level 6 — Security Access Terminal</div>
        <div class="level-desc"></div>
        <button id="btnLevel6" class="btn" onclick="openLevel(6)" disabled>Level 6</button>
      </div>
    </div>

    <div class="cta-row">
      <button class="btn ghost inline" onclick="resetProgress()">Reset Progress</button>
    </div>
  </section>

  <!-- FINAL / MISSION COMPLETE -->
<section id="final" class="screen" style="background: linear-gradient(135deg, #13202b 0%, #091218 100%); min-height:100vh; padding:0;">
  <div class="panel" style="max-width: 640px; margin: 38px auto 0 auto; background:rgba(19,34,46,0.98); border-radius: 15px; border: 2.5px solid #11d8a7; box-shadow: 0 0 34px 8px #0affe544; padding: 44px 30px 36px 30px;">
    <div class="hero" style="text-align: center;">
      <h2 class="title" style="color: #11fcb3; font-family:'Orbitron','Segoe UI',sans-serif; font-size:2.3rem; font-weight:bold; letter-spacing:2px; margin-bottom: 12px;">
        🎉 MISSION ACCOMPLISHED!
      </h2>
      <p class="subtitle" style="font-size:1.15rem; color: #aafff3; margin-bottom: 30px;">All systems restored successfully.</p>
      <div class="stats" style="display: flex; justify-content: center; gap: 48px; margin: 0 0 16px 0;">
        <div class="stat" style="background: #181f26; padding: 20px 38px; border-radius: 12px; border: 2px solid #13f4c6; box-shadow: 0 0 14px 2px #00ffc024;">
          <div class="muted" style="color: #9ed8e8; font-size: 1.03rem; text-transform:uppercase; letter-spacing: .05em;">Total Time</div>
          <div id="final_time" style="font-size:1.6rem;font-weight:800;margin-top:6px;color:#fff;">00:00</div>
        </div>
        <div class="stat" style="background: #181f26; padding: 20px 38px; border-radius: 12px; border: 2px solid #13f4c6; box-shadow: 0 0 14px 2px #00ffc024;">
          <div class="muted" style="color: #9ed8e8; font-size: 1.03rem; text-transform:uppercase; letter-spacing: .05em;">Missions Completed</div>
          <div style="font-size:1.6rem;font-weight:800;margin-top:6px;color:#fff;">6</div>
        </div>
      </div>
      <div class="panel" style="max-width:760px; margin:36px auto 0 auto; background: #192834; border-radius: 10px; border: 2px solid #19ffe5; padding: 22px 26px;">
        <strong style="color: #19ffe5; font-size: 1.08rem;">Outstanding Teamwork!</strong>
        <p class="muted" style="margin-top:8px;color:#dff4fa; font-size: 1.06rem;">Your rapid response successfully defended the company against the cyber attack. All departments are secure and normal operations can resume.</p>
      </div>
      <div class="row" style="margin-top:34px; display: flex; justify-content: center; gap: 24px;">
        <button class="btn inline" onclick="restartMission()" style="background:linear-gradient(90deg,#17ffc5,#41fdff); color:#222; font-size:1.08rem; font-weight:700; border-radius: 7px; border:none; box-shadow:0 0 8px #16ffe370; padding:9px 32px; margin:0 3px; cursor:pointer;transition:background 0.17s;">🔁 New Mission</button>
        <button class="btn inline ghost" onclick="backToHub()" style="background:transparent; border:2px solid #17ffc5; color:#17ffc5; font-size:1.08rem; font-weight:700; border-radius:7px; padding:9px 32px; margin:0 3px; cursor:pointer; transition:background 0.17s, color 0.17s;">↩️ Return to Hub</button>
      </div>
    </div>
  </div>
</section>


  <!-- Level Navigation (shown inside levels) -->
  <template id="navTemplate">
    <div class="topbar">
      <button class="btn ghost inline" onclick="backToHub()">← Back to Hub</button>
      <div class="row">
        <button id="prevLevelBtn" class="btn inline secondary" onclick="prevLevel()">Previous</button>
        <button id="nextLevelBtn" class="btn inline" onclick="nextLevel()" disabled>Next Level →</button>
      </div>
    </div>
  </template>

  <!-- LEVEL 1 -->
  <section id="level1" class="screen">
    <div class="panel l1-wrap">
      <h2 class="title">🧩 Level 1 — Matrix Security System</h2>

      <div class="instructions" style="max-width: 460px; margin: 24px auto; background-color: #1a1a1a; border: 1.5px solid #444; border-radius: 8px; padding: 18px 22px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #ddd; box-shadow: 0 0 15px 1px #3a7adf40;">
  <h3 style="color: #4a9eff; font-weight: 700; font-size: 1.5rem; margin-bottom: 14px; text-align: center; letter-spacing: 0.05em;">
    🎯 MISSION:
  </h3>
  <p style="font-size: 1rem; margin-bottom: 12px; line-height: 1.5;">
    The security system has one sensor already placed <span style="color:#ff4d4d; font-weight: 700;">(marked in red)</span>. You must place <strong style="color:#ffb33a;">5 additional X sensors</strong> on the 3×3 grid.
  </p>
  <p style="font-size: 1rem; font-weight: 700; color: #fc426a; margin: 0; line-height: 1.4; text-align: center;">
    ⚠️ CRITICAL RULE: No three X marks can form a straight line (horizontal, vertical, or diagonal)!
  </p>
</div>




    
      <div class="spacer"></div>

      <div class="center muted">Sensor Placement</div>
      <div class="grid" id="l1_xGrid"></div>

      <div class="row center">
        <button class="btn inline" onclick="l1_reset()">Reset Grid</button>
        <button id="l1_checkBtn" class="btn inline" onclick="l1_check()" disabled>Check Sensor Placement</button>
      </div>

      <div id="l1_warn" class="center hidden muted">⚠️ A straight line of three X's detected. Adjust your placement.</div>
      <div id="l1_ok" class="center hidden msg-ok">✅ Sensor grid configured. Now decode the access code.</div>

      <div class="spacer"></div>
      <div class="center muted">Access Matrix</div>

 <p style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #ccc; font-size: 1rem; line-height: 1.5; max-width: 480px; margin: 16px auto; text-align: center;">
  Enter the 3-digit access code to proceed.
</p>


      <div class="grid" id="l1_numGrid"></div>

      <div class="stack">
        <input id="l1_code" maxlength="9" class="l6-panel code" placeholder="Enter code" />
        <button class="btn inline" onclick="l1_verifyCode()">Unlock</button>
      </div>

      <div id="l1_success" class="center hidden msg-ok">🎉 Access granted! Level 1 complete.</div>
    </div>
  </section>

  <!-- LEVEL 2 -->
  <section id="level2" class="screen">
    <div class="panel">
      <h2 class="title">🚨 Level 2 — Security Breach Grid</h2>

      <p class="subtitle"></p>
<div class="header">
        
       <div class="alert-box" style="border: 2px solid #ff3939; background-color: #220d0d; border-radius: 8px; box-shadow: 0 0 12px 1px #ff393930; padding: 18px 14px 14px 14px; text-align: center; margin-bottom: 12px;">
    <h2 style="color: #ff3939; font-size: 1.1rem; font-family: 'Orbitron', 'Segoe UI', Tahoma, sans-serif; font-weight: 700; margin: 0 0 8px 0; letter-spacing: 1px;">
        ⚠️ ALERT: SYSTEM COMPROMISED!
    </h2>
    <p style="color: #ffbfbf; font-size: 0.98rem; margin: 0; line-height: 1.4; font-weight: 500;">
        Security facility grid is compromised! Navigate through <b style="color:#fff;">ALL</b> grid cells to spell <span style="color:#fc426a; font-weight: 700;">BREACH</span> and unlock the override system.
    </p>
</div>

<div style="border: 2px solid #555; padding: 20px 20px 18px 20px; background-color: #151515; color: #e1e1e1; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 15px; border-radius: 10px; line-height: 1.7; max-width: 520px; margin: 0 auto; box-shadow: 0 0 12px 2px #ff4d4daa;">
  <strong style="color: #ff4d4d; font-size: 18px; text-transform: uppercase; display: block; margin-bottom: 12px; letter-spacing: 1.2px; font-family: 'Orbitron', 'Segoe UI', Tahoma, sans-serif;">
    ESCAPE PROTOCOL:
  </strong>
  <ul style="padding-left: 18px; margin: 0; list-style-type: disc;">
    <li style="margin-bottom: 8px;">Connect the scattered letters to form a security override word</li>
    <li style="margin-bottom: 8px;">Must pass through <strong style="color:#fffadc;">EVERY</strong> single cell in the grid</li>
    <li>Form one continuous path from start to finish</li>
  </ul>
</div>



    <div class="puzzle-container">

      


      <div id="l2_grid" class="l2-grid"></div>

      <div class="row muted">
        <div>Cells Filled: <span id="l2_cells">0/30</span></div>
        <div>Letters Connected: <span id="l2_letters">0/6</span></div>
      </div>





      <div class="row">
        <button class="btn inline" onclick="l2_reset()">Reset</button>
        
      </div>


     <div class="how-to-play" style="max-width: 480px; margin: 24px auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #eee; background: #1a1a1a; padding: 16px 22px; border-radius: 8px; border: 1.5px solid #444; box-shadow: 0 0 12px 1px #3a7adf40;">

    <h3 style="text-align: center; color: #4a9eff; font-weight: 700; font-size: 1.4rem; letter-spacing: 0.03em; margin-bottom: 16px;">How to play</h3>

    <div class="play-example" style="display: flex; align-items: center; justify-content: space-around; margin-bottom: 14px; flex-wrap: wrap; gap: 12px;">
        
        <div class="example-dots" style="display: flex; gap: 8px;">
            <div class="example-dot" style="background-color: #ff3939; color: white; font-weight: bold; font-family: 'Consolas', monospace; font-size: 1.2rem; width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; user-select: none;">B</div>
            <div class="example-dot" style="background-color: #ff3939; color: white; font-weight: bold; font-family: 'Consolas', monospace; font-size: 1.2rem; width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; user-select: none;">R</div>
            <div class="example-dot" style="background-color: #ff3939; color: white; font-weight: bold; font-family: 'Consolas', monospace; font-size: 1.2rem; width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; user-select: none;">E</div>
        </div>

        <div style="color: #4a9eff; font-weight: 700; user-select: none; min-width: 120px; text-align: center;">Connect letters in order</div>

        <div class="example-grid" style="width: 36px; height: 36px; background-color: #fff; border-radius: 6px; box-shadow: 0 0 5px #4a9effaa inset; user-select: none; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; line-height: 1;">⬜</div>

        <div style="color: #4a9eff; font-weight: 700; user-select: none; min-width: 96px; text-align: center;">Fill every cell</div>
    </div>
    
    <p style="text-align: center; margin-top: 15px; font-size: 14px; line-height: 1.4; color: #bbb; user-select: none;">
        Click and drag to create a path that visits all 30 cells and connects all the letters
    </p>
</div>



      <div id="l2_message" class="center hidden msg-ok">🎉 Security override complete! BREACH confirmed.</div>
    </div>
  </section>

  <!-- LEVEL 3 -->
  <section id="level3" class="screen">
    <div class="panel">
      <h2 class="title">🔊 Level 3 — Audio Decoder</h2>
      <p class="subtitle"></p>


     <div class="instructions-box" style="max-width: 460px; margin: 24px auto; background-color: #1a1a1a; border: 1.5px solid #444; border-radius: 8px; padding: 18px 22px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #ddd; box-shadow: 0 0 15px 1px #3a7adf40;">
  <h3 style="color: #00d4ff; margin-bottom: 15px; font-weight: 700; font-size: 1.45rem; text-align: center; letter-spacing: 0.05em;">
    📋 Mission Instructions:
  </h3>
  <ul class="instructions-list" style="padding-left: 20px; margin: 0; font-size: 1rem; line-height: 1.5;">
    <li style="margin-bottom: 8px;">Listen to the classified audio file</li>
    <li style="margin-bottom: 8px;">Complete the security verification</li>
    <li style="margin-bottom: 8px;">Enter the required data fields</li>
    <li>Submit for system access</li>
  </ul>
</div>



      

      <div class="l3-audio">
        <audio id="l3_audio" controls preload="auto">
          <source src="bullet_code_2684.wav" type="audio/wav" />
          Your browser does not support the audio element.
        </audio>


<!-- Grid for the three decode items -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; max-width: 1000px; margin: 32px auto;">
  <div class="decode-item" style="background: #222; border-radius: 12px; padding: 22px 20px; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0 0 0 3px #0ff08b, 0 0 18px 2px #0ff08b60; text-align: center; border: 2px solid #0ff08b;">
    <h4 style="margin: 0 0 10px; color: #ff493a; font-weight: 700; font-size: 1.25rem;">🎯 Data Processing</h4>
    <p style="margin: 0; font-size: 1rem; line-height: 1.5; font-weight: 500;">Extract required information from the transmission.</p>
  </div>
  <div class="decode-item" style="background: #222; border-radius: 12px; padding: 22px 20px; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0 0 0 3px #15b2ff, 0 0 18px 2px #15b2ff60; text-align: center; border: 2px solid #15b2ff;">
    <h4 style="margin: 0 0 10px; color: #15b2ff; font-weight: 700; font-size: 1.25rem;">🔢 System Input</h4>
    <p style="margin: 0; font-size: 1rem; line-height: 1.5; font-weight: 500;">Complete all mandatory data fields for verification.</p>
  </div>
  <div class="decode-item" style="background: #222; border-radius: 12px; padding: 22px 20px; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0 0 0 3px #ffce33, 0 0 18px 2px #ffce3360; text-align: center; border: 2px solid #ffce33;">
    <h4 style="margin: 0 0 10px; color: #ffce33; font-weight: 700; font-size: 1.25rem;">⚡ Access Control</h4>
    <p style="margin: 0; font-size: 1rem; line-height: 1.5; font-weight: 500;">Submit credentials to unlock secure systems.</p>
  </div>
</div>

<!-- Separate system notice grid -->
<div class="hint-box" style="max-width: 500px; margin: 28px auto 0 auto; background-color: #162136; padding: 17px 20px; border-radius: 14px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #f7fae3; font-size: 1.09rem; box-shadow: 0 0 24px 2px #0dbfff55; text-align: center; font-weight: 600;">
  💡 <strong style="color: #38bdff;">System Notice:</strong> Complete all required fields to proceed with security verification.
</div>



           <div class="decode-grid">


       

        <div class="muted">Tip: Hear the rhythm/code within the pattern.</div>
      </div>

      <div class="stack">
        <input id="l3_code" class="l6-panel code" maxlength="8" placeholder="Enter credential" />
        <button class="btn inline" onclick="l3_submit()">Submit</button>
      </div>

      <div id="l3_ok" class="center hidden msg-ok">✅ ACCESS CREDENTIAL ACCEPTED! Level 3 complete.</div>
      <div id="l3_bad" class="center hidden msg-bad">❌ Invalid credential. Try again.</div>
    </div>
  </section>

  <!-- LEVEL 4 -->
  <section id="level4" class="screen">
    <div class="panel l4-wrap">
      <h2 class="title">🔐 Level 4 — Will You Crack the Code?</h2>

      <div class="instructions" style="background: #171d25; color: #fafcfd; border-radius: 12px; border: 1.5px solid #25d0e6; box-shadow: 0 0 14px 1px #2fffd522; max-width: 520px; margin: 28px auto 20px auto; padding: 24px 24px 18px 24px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <h3 style="color: #19ffe5; font-weight: bold; font-size: 1.23rem; margin-bottom: 13px; letter-spacing: 0.04em;">
        🎯 MISSION:
    </h3>
    <p style="margin-bottom: 13px; line-height: 1.5;">
        Analyze the clues below to determine the correct <strong style="color:#ffce33;">3-digit code</strong>. Each clue provides information about how many digits are correct and whether they're in the right position.
    </p>
    <p style="font-weight: bold; color: #ff5c6c; margin-bottom: 8px;">
        ⚠️ LEGEND:
    </p>
    <ul style="margin-top: 10px; padding-left: 22px; line-height: 1.6;">
        <li><strong style="color:#7cff8c;">Correct and well placed:</strong> The digit is in the code AND in the correct position</li>
        <li><strong style="color:#23bbec;">Correct but wrong placed:</strong> The digit is in the code BUT in the wrong position</li>
        <li><strong style="color:#fa3b71;">Nothing is correct:</strong> None of the digits are in the code</li>
    </ul>
</div>

            

      <p class="subtitle"></p>

      <div class="lock-display">
        <div class="lock-icon" id="l4_lock">🔒</div>
        <div class="code-slots">
          <div class="code-slot" id="l4_slot1">?</div>
          <div class="code-slot" id="l4_slot2">?</div>
          <div class="code-slot" id="l4_slot3">?</div>
        </div>
      </div>

      <div class="clue-section">
        <div class="clue-row">
          <div class="clue-numbers">
            <div class="clue-digit">6</div>
            <div class="clue-digit">8</div>
            <div class="clue-digit">2</div>
          </div>
          <div class="clue-text">One number is correct and well placed</div>
        </div>
        <div class="clue-row">
          <div class="clue-numbers">
            <div class="clue-digit">6</div>
            <div class="clue-digit">1</div>
            <div class="clue-digit">4</div>
          </div>
          <div class="clue-text">One number is correct but wrong placed</div>
        </div>
        <div class="clue-row">
          <div class="clue-numbers">
            <div class="clue-digit">2</div>
            <div class="clue-digit">0</div>
            <div class="clue-digit">6</div>
          </div>
          <div class="clue-text">Two numbers are correct but wrong placed</div>
        </div>
        <div class="clue-row">
          <div class="clue-numbers">
            <div class="clue-digit">7</div>
            <div class="clue-digit">3</div>
            <div class="clue-digit">8</div>
          </div>
          <div class="clue-text">Nothing is correct</div>
        </div>
        <div class="clue-row">
          <div class="clue-numbers">
            <div class="clue-digit">7</div>
            <div class="clue-digit">8</div>
            <div class="clue-digit">0</div>
          </div>
          <div class="clue-text">One number is correct but wrong placed</div>
        </div>
      </div>

      <div class="stack">
        <input id="l4_input" class="code-input" maxlength="3" placeholder="???">
        <div class="row">
          <button class="btn inline" onclick="l4_check()">Unlock</button>
          <button class="btn inline ghost" onclick="l4_reset()">Reset</button>
        </div>
      </div>

      <div class="attempts">Attempts: <span id="l4_attempts">0</span></div>
      <div id="l4_warn" class="warning"></div>

      <div id="l4_success" class="success">
        <h3>🎉 CODE CRACKED!</h3>
        <div style="font-size:1.2rem;margin:8px 0;">Correct Code: <span id="l4_correct"></span></div>
        <div class="panel" style="margin-top:10px;text-align:left;">
          <strong>Solution breakdown:</strong>
          <div id="l4_explain" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- LEVEL 5 -->
  <section id="level5" class="screen">
    <div class="panel">
      <h2 class="title">🧮 Level 5 — Cross Number Puzzle</h2>


     <h3 style="text-align: center; color: #19ffe5; font-family: 'Orbitron','Segoe UI',sans-serif; font-size: 2rem; font-weight: bold; letter-spacing: 1.5px; margin-top: 18px; margin-bottom: 18px;">
  MATHEMATICAL CROSSES
</h3>

<div class="instructions" style="background: #171d25; color: #fafcfd; border-radius: 11px; border: 1.5px solid #19ffe5; box-shadow: 0 0 13px 0 #1efdff55; max-width: 520px; margin: 0 auto 25px auto; padding: 24px 24px 18px 24px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <h3 style="color: #35ff7a; font-weight: bold; font-size: 1.17rem; margin-bottom: 12px; letter-spacing: 0.04em;">
        🎯 OBJECTIVE:
    </h3>
    <p style="margin-bottom: 11px; line-height: 1.5;">
        Find the missing number in the middle cross. Each cross follows a <span style="color:#ffd351; font-weight:600;">mathematical pattern</span> where the center number relates to the four surrounding numbers.
    </p>
</div>


      <div class="l5-crosses">
        <div class="l5-cross">
          <div class="l5-cell t">99</div>
          <div class="l5-cell l">43</div>
          <div class="l5-cell c">?</div>
          <div class="l5-cell r">47</div>
          <div class="l5-cell b">9</div>
        </div>

        <div class="l5-cross" id="l5_cross2">
          <div class="l5-cell t">99</div>
          <div class="l5-cell l">47</div>
          <div class="l5-cell c" id="l5_c2"></div>
          <div class="l5-cell r">15</div>
          <div class="l5-cell b input" id="l5_b2" onclick="l5_showInput()">?</div>
        </div>

        <div class="l5-cross">
          <div class="l5-cell t">99</div>
          <div class="l5-cell l">21</div>
          <div class="l5-cell c"></div>
          <div class="l5-cell r">31</div>
          <div class="l5-cell b">47</div>
        </div>
      </div>

      <div class="center l5-note">Click the highlighted bottom cell to enter the missing center for Cross #2, then submit the 2-digit  code.</div>

      <div class="row" style="margin-top:14px;">
        <input id="l5_hiddenAnswer" class="l5-number-input" type="number" placeholder="?" style="display:none;">
        <button id="l5_checkBtn" class="btn inline" onclick="l5_checkAnswer()" style="display:none;">Check</button>
        <button class="btn inline ghost" onclick="l5_reset()">Reset</button>
      </div>

      <div class="stack" style="margin-top:10px;">
        <input id="l5_final" class="l6-panel code" maxlength="2" placeholder="##">
        <button class="btn inline" onclick="l5_submit()">Submit Code</button>
      </div>

      <div id="l5_ok" class="center hidden msg-ok">🚀 SYSTEM UNLOCKED! Level 5 complete.</div>
      <div id="l5_bad" class="center hidden msg-bad">❌ Incorrect. Re-evaluate the pattern.</div>
    </div>
  </section>

  <!-- LEVEL 6 -->
  <section id="level6" class="screen">
    <div class="panel l6-panel">
      <h2 class="title">🔓 Level 6 — Security Access Terminal</h2>
      <p class="subtitle"></p>

      <div class="l6-directive-grid">
        <div class="l6-panelBox">
          <div class="l6-panelId">ALPHA</div>
          <div class="l6-seq"><span class="l6-cmd">↓</span><span class="l6-cmd">↓</span><span class="l6-cmd">↓</span></div>
        </div>
        <div class="l6-panelBox">
          <div class="l6-panelId">BETA</div>
          <div class="l6-seq"><span class="l6-cmd">→</span><span class="l6-cmd">↓</span><span class="l6-cmd">↓</span></div>
        </div>
        <div class="l6-panelBox">
          <div class="l6-panelId">GAMMA</div>
          <div class="l6-seq"><span class="l6-cmd">←</span><span class="l6-cmd">↓</span><span class="l6-cmd">→</span><span class="l6-cmd">↓</span><span class="l6-cmd">←</span></div>
        </div>
        <div class="l6-panelBox">
          <div class="l6-panelId">DELTA</div>
          <div class="l6-seq"><span class="l6-cmd">→</span><span class="l6-cmd">↓</span><span class="l6-cmd">←</span><span class="l6-cmd">↑</span></div>
        </div>
      </div>

      <div class="stack">
        <input id="l6_code" maxlength="4" class="code" placeholder="----" />
        <button class="btn inline" onclick="l6_auth()">Authenticate</button>
      </div>

      <div id="l6_ok" class="center hidden msg-ok">✅ ACCESS GRANTED — You finished all levels! 🎉</div>
      <div id="l6_bad" class="center hidden msg-bad">❌ ACCESS DENIED — Invalid code.</div>

      <div class="l6-hint">💡 Hint: Use your pen</div>
    </div>
  </section>

  <script>
    /* ================== PROGRESS / NAV ================== */
    const TOTAL_LEVELS = 6;
    const LS_UNLOCK_KEY = 'hub_unlocked_level_v1';
    const LS_VIEW_KEY = 'hub_current_view_v1';
    const LS_TIMER_START = 'hub_timer_start_v1';
    const LS_TIMER_END = 'hub_timer_end_v1';

    function getUnlockedLevel() {
      const v = parseInt(localStorage.getItem(LS_UNLOCK_KEY) || '1', 10);
      return Number.isNaN(v) ? 1 : Math.min(Math.max(v, 1), TOTAL_LEVELS);
    }
    function setUnlockedLevel(level) {
      const cur = getUnlockedLevel();
      if (level > cur) {
        localStorage.setItem(LS_UNLOCK_KEY, String(level));
      }
      updateHubButtons();
    }
    function saveCurrentView(viewId) {
      localStorage.setItem(LS_VIEW_KEY, viewId);
    }
    function restoreView() {
      const v = localStorage.getItem(LS_VIEW_KEY);
      if (v && document.getElementById(v)) {
        showScreen(v);
      } else {
        showScreen('hub');
      }
    }

    function updateHubButtons() {
      const unlocked = getUnlockedLevel();
      for (let i = 1; i <= TOTAL_LEVELS; i++) {
        const btn = document.getElementById('btnLevel' + i);
        if (btn) btn.disabled = i > unlocked;
        if (btn && i === 1 && unlocked <= 1) btn.classList.add('glow');
        else if (btn) btn.classList.remove('glow');
      }
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
      // Always bring user to top when switching screens
      try {
        // Instant jump to top to avoid any need to scroll for the user
        window.scrollTo(0, 0);
        // Ensure focus enters the section for screen readers and keyboards
        if (el && typeof el.scrollIntoView === 'function') {
          el.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'auto' });
        }
      } catch(_) {}

      // inject level nav if needed
      if (id.startsWith('level')) {
        const levelNum = parseInt(id.replace('level', ''), 10);
        ensureNav(el, levelNum);
      }
      saveCurrentView(id);
      if (id === 'level1') l1_init();
      if (id === 'level2') l2_init();
    }

    function ensureNav(container, levelNum) {
      if (!container.querySelector('.topbar')) {
        const tpl = document.getElementById('navTemplate');
        const nav = tpl.content.cloneNode(true);
        container.prepend(nav);
      }
      const prevBtn = container.querySelector('#prevLevelBtn');
      const nextBtn = container.querySelector('#nextLevelBtn');
      if (prevBtn) prevBtn.disabled = (levelNum <= 1);
      if (nextBtn) nextBtn.disabled = (getUnlockedLevel() < (levelNum + 1)) || (levelNum >= TOTAL_LEVELS);
    }

    function openLevel(n) {
      showScreen('level' + n);
    }
    function backToHub() {
      showScreen('hub');
    }
    function prevLevel() {
      const current = getCurrentLevelFromView();
      if (current > 1) showScreen('level' + (current - 1));
    }
    function nextLevel() {
      const current = getCurrentLevelFromView();
      const unlocked = getUnlockedLevel();
      if (current < TOTAL_LEVELS && unlocked >= current + 1) {
        showScreen('level' + (current + 1));
      }
    }
    function getCurrentLevelFromView() {
      const v = localStorage.getItem(LS_VIEW_KEY) || 'hub';
      if (v.startsWith('level')) return parseInt(v.replace('level', ''), 10);
      return 0;
    }
    function markLevelComplete(levelNum) {
      const next = Math.min(levelNum + 1, TOTAL_LEVELS);
      setUnlockedLevel(next);

      // enable Next Level button in this screen's nav (if present)
      const view = document.getElementById('level' + levelNum);
      if (view) {
        const nextBtn = view.querySelector('#nextLevelBtn');
        if (nextBtn && levelNum < TOTAL_LEVELS) nextBtn.disabled = false;
      }
      updateHubButtons();
    }
    function resetProgress() {
      localStorage.removeItem(LS_UNLOCK_KEY);
      localStorage.removeItem(LS_VIEW_KEY);
      localStorage.removeItem(LS_TIMER_START);
      localStorage.removeItem(LS_TIMER_END);
      stopTimerUI(true);
      resetAllLevels();
      updateHubButtons();
      showScreen('intro');
    }

    // Initial
    updateHubButtons();
    // Default to intro if no saved view
    const savedView = localStorage.getItem(LS_VIEW_KEY);
    if (savedView) restoreView(); else showScreen('intro');

    /* ================== TIMER (TOTAL) ================== */
    function beginEmergency() {
      if (!localStorage.getItem(LS_TIMER_START)) {
        localStorage.setItem(LS_TIMER_START, String(Date.now()));
        localStorage.removeItem(LS_TIMER_END);
      }
      startTimerUI();
      showScreen('hub');
    }
    function getElapsedMs() {
      const start = parseInt(localStorage.getItem(LS_TIMER_START) || '0', 10);
      const end = parseInt(localStorage.getItem(LS_TIMER_END) || '0', 10);
      if (!start) return 0;
      const now = end || Date.now();
      return Math.max(0, now - start);
    }
    function fmt(ms) {
      const s = Math.floor(ms / 1000);
      const mm = Math.floor(s / 60).toString().padStart(2, '0');
      const ss = (s % 60).toString().padStart(2, '0');
      return `${mm}:${ss}`;
    }
    function showFinal() {
      const ms = getElapsedMs();
      document.getElementById('final_time').textContent = fmt(ms);
      stopTimerUI(false); // freeze time on badge too
      showScreen('final');
    }
    function restartMission() {
      resetProgress();
    }

    // Floating timer UI
    let _timerHandle = null;
    function updateTimerUI() {
      const el = document.getElementById('missionTimer');
      const ms = getElapsedMs();
      el.textContent = '⏱️ ' + fmt(ms);
    }
    function startTimerUI() {
      const el = document.getElementById('missionTimer');
      el.style.display = 'inline-block';
      updateTimerUI();
      if (_timerHandle) clearInterval(_timerHandle);
      _timerHandle = setInterval(updateTimerUI, 1000);
    }
    function stopTimerUI(hide = true) {
      if (_timerHandle) { clearInterval(_timerHandle); _timerHandle = null; }
      if (hide) document.getElementById('missionTimer').style.display = 'none';
      else updateTimerUI();
    }

    // Hard reset of all level states and UI so a new mission truly starts fresh
    function resetAllLevels() {
      // Level 1
      try {
        l1_inited = false;
        l1_solvedGrid = false;
        l1_positions = new Set(['2,2']);
        const xg = document.getElementById('l1_xGrid'); if (xg) xg.innerHTML = '';
        const ng = document.getElementById('l1_numGrid'); if (ng) ng.innerHTML = '';
        const chk = document.getElementById('l1_checkBtn'); if (chk) chk.disabled = true;
        const warn = document.getElementById('l1_warn'); if (warn) warn.classList.add('hidden');
        const ok = document.getElementById('l1_ok'); if (ok) ok.classList.add('hidden');
        const succ = document.getElementById('l1_success'); if (succ) succ.classList.add('hidden');
        const code = document.getElementById('l1_code'); if (code) code.value = '';
      } catch(_) {}

      // Level 2
      try {
        l2_inited = false; l2_isDown = false; l2_path = []; l2_letters = []; l2_last = null;
        const grid = document.getElementById('l2_grid'); if (grid) grid.innerHTML = '';
        const msg = document.getElementById('l2_message'); if (msg) msg.classList.add('hidden');
        const cells = document.getElementById('l2_cells'); if (cells) cells.textContent = '0/30';
        const lets = document.getElementById('l2_letters'); if (lets) lets.textContent = '0/6';
      } catch(_) {}

      // Level 3
      try {
        const l3ok = document.getElementById('l3_ok'); if (l3ok) l3ok.classList.add('hidden');
        const l3bad = document.getElementById('l3_bad'); if (l3bad) l3bad.classList.add('hidden');
        const l3in = document.getElementById('l3_code'); if (l3in) l3in.value = '';
        const a = document.getElementById('l3_audio'); if (a) { a.pause(); a.currentTime = 0; }
      } catch(_) {}

      // Level 4
      try { l4_reset(); } catch(_) {}

      // Level 5
      try {
        l5_solved = false;
        const c2 = document.getElementById('l5_c2'); if (c2) c2.textContent = '';
        const b2 = document.getElementById('l5_b2'); if (b2) { b2.textContent = '?'; b2.classList.add('input'); b2.onclick = l5_showInput; }
        const fin = document.getElementById('l5_final'); if (fin) fin.value = '';
        const ok5 = document.getElementById('l5_ok'); if (ok5) ok5.classList.add('hidden');
        const bad5 = document.getElementById('l5_bad'); if (bad5) bad5.classList.add('hidden');
        const hin = document.getElementById('l5_hiddenAnswer'); if (hin) { hin.value=''; hin.style.display='none'; }
        const chk5 = document.getElementById('l5_checkBtn'); if (chk5) chk5.style.display='none';
      } catch(_) {}

      // Level 6
      try {
        const ok6 = document.getElementById('l6_ok'); if (ok6) ok6.classList.add('hidden');
        const bad6 = document.getElementById('l6_bad'); if (bad6) bad6.classList.add('hidden');
        const code6 = document.getElementById('l6_code'); if (code6) code6.value = '';
      } catch(_) {}
    }

    /* ================== LEVEL 1 ================== */
    // Grid: 3x3. Predefined X at 2,2. Must place total 6 Xs without collinear triple.
    const l1_numbers = [
      [7,3,9],
      [2,5,1],
      [8,4,6]
    ];
    let l1_inited = false;
    let l1_solvedGrid = false;
    let l1_positions = new Set(['2,2']); // prefilled
    const L1_MAX = 6; // total X including predefined

    function l1_init() {
      if (l1_inited) return;
      l1_inited = true;

      // build sensor grid
      const g = document.getElementById('l1_xGrid');
      g.innerHTML = '';
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          const d = document.createElement('div');
          d.className = 'cell';
          d.dataset.pos = r + ',' + c;
          if (r === 2 && c === 2) {
            d.classList.add('pre');
            d.textContent = 'X';
          }
          d.addEventListener('click', () => {
            if (l1_solvedGrid) return;
            if (d.classList.contains('pre')) return;
            const pos = d.dataset.pos;
            if (l1_positions.has(pos)) {
              l1_positions.delete(pos);
              d.classList.remove('placed');
              d.textContent = '';
            } else if (l1_positions.size < L1_MAX) {
              l1_positions.add(pos);
              d.classList.add('placed');
              d.textContent = 'X';
            }
            document.getElementById('l1_checkBtn').disabled = (l1_positions.size !== L1_MAX);
            document.getElementById('l1_warn').classList.add('hidden');
          });
          g.appendChild(d);
        }
      }

      // build number grid
      const n = document.getElementById('l1_numGrid');
      n.innerHTML = '';
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          const d = document.createElement('div');
          d.className = 'cell';
          d.textContent = String(l1_numbers[r][c]);
          d.style.borderColor = 'rgba(0,212,255,.35)';
          d.style.color = '#00d4ff';
          n.appendChild(d);
        }
      }
    }

    function l1_reset() {
      if (l1_solvedGrid) return;
      l1_positions = new Set(['2,2']);
      document.querySelectorAll('#l1_xGrid .cell').forEach(d => {
        if (!d.classList.contains('pre')) {
          d.classList.remove('placed');
          d.textContent = '';
        }
      });
      document.getElementById('l1_checkBtn').disabled = true;
      document.getElementById('l1_warn').classList.add('hidden');
      document.getElementById('l1_ok').classList.add('hidden');
      document.getElementById('l1_success').classList.add('hidden');
      document.getElementById('l1_code').value = '';
    }

    function l1_check() {
      if (l1_positions.size !== L1_MAX) return;
      const coords = Array.from(l1_positions).map(p => p.split(',').map(Number));
      // check any collinear triple
      for (let i = 0; i < coords.length - 2; i++) {
        for (let j = i + 1; j < coords.length - 1; j++) {
          for (let k = j + 1; k < coords.length; k++) {
            const [x1,y1] = coords[i];
            const [x2,y2] = coords[j];
            const [x3,y3] = coords[k];
            const area = Math.abs(x1*(y2-y3) + x2*(y3-y1) + x3*(y1-y2));
            if (area === 0) {
              document.getElementById('l1_warn').classList.remove('hidden');
              return;
            }
          }
        }
      }
      l1_solvedGrid = true;
      document.getElementById('l1_ok').classList.remove('hidden');
    }

    function l1_emptyPositions() {
      const res = [];
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          const pos = r + ',' + c;
          if (!l1_positions.has(pos)) res.push(pos);
        }
      }
      res.sort(); // deterministic
      return res;
    }

    function l1_verifyCode() {
      if (!l1_solvedGrid) return;
      const empties = l1_emptyPositions();
      const correct = empties.map(p => {
        const [r,c] = p.split(',').map(Number);
        return l1_numbers[r][c];
      }).join('');
      const input = (document.getElementById('l1_code').value || '').trim();
      if (input === correct) {
        document.getElementById('l1_success').classList.remove('hidden');
        markLevelComplete(1);
      } else {
        alert('❌ Incorrect code. Check the empty positions against the number matrix.');
      }
    }

    /* ================== LEVEL 2 ================== */
    // 6x5 grid, letters must form BREACH and all 30 cells visited
    const l2_layout = [
      ['', '', '', 'H', '', ''],
      ['B', '', '', '', '', 'A'],
      ['', '', '', '', '', ''],
      ['', 'R', '', '', 'C', ''],
      ['', '', 'E', '', '', '']
    ];
    let l2_inited = false;
    let l2_isDown = false;
    let l2_path = [];
    let l2_letters = [];
    let l2_last = null;

    function l2_init() {
      if (l2_inited) return;
      l2_inited = true;

      const grid = document.getElementById('l2_grid');
      grid.innerHTML = '';
      for (let r = 0; r < 5; r++) {
        for (let c = 0; c < 6; c++) {
          const d = document.createElement('div');
          d.className = 'l2-cell';
          d.dataset.r = r; d.dataset.c = c;
          const letter = l2_layout[r][c];
          if (letter) {
            d.classList.add('letter');
            d.dataset.letter = letter;
            d.textContent = letter;
          }
          d.addEventListener('mousedown', l2_start);
          d.addEventListener('mouseenter', l2_drag);
          grid.appendChild(d);
        }
      }
      document.addEventListener('mouseup', l2_stop);
      l2_highlightTarget();
      l2_updateStats();
    }

    function l2_start(e) {
      e.preventDefault();
      l2_reset(); // new path each time
      l2_isDown = true;
      l2_add(e.currentTarget);
    }
    function l2_drag(e) {
      if (!l2_isDown) return;
      e.preventDefault();
      const cur = e.currentTarget;
      if (!l2_last || l2_isAdjacent(cur, l2_last)) l2_add(cur);
    }
    function l2_stop() {
      l2_isDown = false;
      l2_last = null;
    }
    function l2_isAdjacent(a, b) {
      const ar = +a.dataset.r, ac = +a.dataset.c;
      const br = +b.dataset.r, bc = +b.dataset.c;
      const rd = Math.abs(ar - br), cd = Math.abs(ac - bc);
      return (rd === 1 && cd === 0) || (rd === 0 && cd === 1);
    }
    function l2_add(cell) {
      const key = cell.dataset.r + '-' + cell.dataset.c;
      if (l2_path.includes(key)) return;
      l2_path.push(key);
      cell.classList.add('connected');
      l2_last = cell;

      // letter order
      const seq = ['B','R','E','A','C','H'];
      const target = seq[l2_letters.length];
      if (cell.dataset.letter) {
        if (cell.dataset.letter === target) {
          l2_letters.push(cell.dataset.letter);
          l2_highlightTarget();
        } else {
          // wrong letter order → ignore taking it, but keep path
        }
      }

      l2_updateStats();
      l2_checkWin();
    }
    function l2_highlightTarget() {
      document.querySelectorAll('#l2_grid .l2-cell.current').forEach(x => x.classList.remove('current'));
      const seq = ['B','R','E','A','C','H'];
      const target = seq[l2_letters.length];
      if (!target) return;
      const nextCell = Array.from(document.querySelectorAll('#l2_grid .l2-cell.letter'))
        .find(x => x.dataset.letter === target && !x.classList.contains('connected'));
      if (nextCell) nextCell.classList.add('current');
    }
    function l2_updateStats() {
      document.getElementById('l2_cells').textContent = l2_path.length + '/30';
      document.getElementById('l2_letters').textContent = l2_letters.length + '/6';
    }
    function l2_checkWin() {
      if (l2_path.length === 30 && l2_letters.join('') === 'BREACH') {
        document.getElementById('l2_message').classList.remove('hidden');
        markLevelComplete(2);
      }
    }
    function l2_reset() {
      l2_path = [];
      l2_letters = [];
      l2_last = null;
      document.getElementById('l2_message').classList.add('hidden');
      document.querySelectorAll('#l2_grid .l2-cell').forEach(x => x.classList.remove('connected','current'));
      l2_highlightTarget();
      l2_updateStats();
    }

    /* ================== LEVEL 3 ================== */
    // Minimal version: correct credential string
    const L3_CORRECT = '3795'; // aligned with your file

    function l3_submit() {
      const code = (document.getElementById('l3_code').value || '').trim();
      document.getElementById('l3_ok').classList.add('hidden');
      document.getElementById('l3_bad').classList.add('hidden');
      if (code === L3_CORRECT) {
        document.getElementById('l3_ok').classList.remove('hidden');
        markLevelComplete(3);
      } else {
        document.getElementById('l3_bad').classList.remove('hidden');
      }
    }

    /* ================== LEVEL 4 (full logic) ================== */
    const L4_CORRECT = '042';
    const L4_STEPS = [
      'From clue 4: 7, 3, 8 are NOT in the code',
      'From clue 5: Since 7,8 are eliminated, 0 is correct but wrong placed (not position 3)',
      'From clue 1: Since 8 is eliminated, either 6 or 2 is correct and well placed',
      'From clue 3: 2 and 0 are correct but wrong placed, 6 is not in the code',
      'Therefore in clue 1: 2 must be correct and well placed (position 3)',
      'So 0 goes to position 2 (wrong placed earlier)',
      'From clue 2: 4 is correct but wrong placed → position 1',
      'Final answer: 042'
    ];
    let l4_attempts = 0;

    function l4_check() {
      const input = (document.getElementById('l4_input').value || '').trim();
      document.getElementById('l4_warn').style.display = 'none';
      document.getElementById('l4_success').style.display = 'none';

      if (input.length !== 3) {
        l4_showWarn('Please enter a 3-digit code.');
        return;
      }
      l4_attempts++;
      document.getElementById('l4_attempts').textContent = String(l4_attempts);

      if (input === L4_CORRECT) {
        document.getElementById('l4_slot1').textContent = input[0];
        document.getElementById('l4_slot2').textContent = input[1];
        document.getElementById('l4_slot3').textContent = input[2];
        document.getElementById('l4_lock').textContent = '🔓';
        document.getElementById('l4_correct').textContent = L4_CORRECT;
        document.getElementById('l4_explain').innerHTML = L4_STEPS.map((s,i)=>`<p style="margin:6px 0;border-left:3px solid rgba(0,255,136,.3);padding-left:10px;"><strong>${i+1}.</strong> ${s}</p>`).join('');
        document.getElementById('l4_success').style.display = 'block';
        markLevelComplete(4);
      } else {
        l4_showWarn('❌ Incorrect code. Recheck the clues.');
      }
    }
    function l4_showWarn(msg) {
      const el = document.getElementById('l4_warn');
      el.textContent = msg;
      el.style.display = 'block';
    }
    function l4_reset() {
      l4_attempts = 0;
      document.getElementById('l4_attempts').textContent = '0';
      document.getElementById('l4_input').value = '';
      document.getElementById('l4_slot1').textContent = '?';
      document.getElementById('l4_slot2').textContent = '?';
      document.getElementById('l4_slot3').textContent = '?';
      document.getElementById('l4_lock').textContent = '🔒';
      document.getElementById('l4_warn').style.display = 'none';
      document.getElementById('l4_success').style.display = 'none';
    }

    /* ================== LEVEL 5 (full logic) ================== */
    let l5_solved = false;
    function l5_showInput() {
      if (l5_solved) return;
      document.getElementById('l5_hiddenAnswer').style.display = 'block';
      document.getElementById('l5_checkBtn').style.display = 'inline-block';
      document.getElementById('l5_hiddenAnswer').focus();
    }
    function l5_checkAnswer() {
      const val = (document.getElementById('l5_hiddenAnswer').value || '').trim();
      if (val === '37') {
        document.getElementById('l5_c2').textContent = '37';
        const b = document.getElementById('l5_b2');
        b.textContent = '37';
        b.classList.remove('input');
        b.onclick = null;
        l5_solved = true;
        document.getElementById('l5_hiddenAnswer').style.display = 'none';
        document.getElementById('l5_checkBtn').style.display = 'none';
      } else {
        alert('❌ Not quite right! Look more carefully at the pattern.');
      }
    }
    function l5_submit() {
      const code = (document.getElementById('l5_final').value || '').trim();
      document.getElementById('l5_ok').classList.add('hidden');
      document.getElementById('l5_bad').classList.add('hidden');
      if (code === '37') {
        document.getElementById('l5_ok').classList.remove('hidden');
        markLevelComplete(5);
      } else {
        document.getElementById('l5_bad').classList.remove('hidden');
      }
    }
    function l5_reset() {
      l5_solved = false;
      document.getElementById('l5_final').value = '';
      document.getElementById('l5_ok').classList.add('hidden');
      document.getElementById('l5_bad').classList.add('hidden');
      document.getElementById('l5_hiddenAnswer').value = '';
      document.getElementById('l5_hiddenAnswer').style.display = 'none';
      document.getElementById('l5_checkBtn').style.display = 'none';
      const c = document.getElementById('l5_c2');
      const b = document.getElementById('l5_b2');
      c.textContent = '?';
      b.textContent = '?';
      b.classList.add('input');
      b.onclick = l5_showInput;
    }

    /* ================== LEVEL 6 ================== */
    const L6_VALID = '1750';

    function l6_auth() {
      const input = (document.getElementById('l6_code').value || '').trim();
      document.getElementById('l6_ok').classList.add('hidden');
      document.getElementById('l6_bad').classList.add('hidden');
      if (input === L6_VALID) {
        document.getElementById('l6_ok').classList.remove('hidden');
        // stop timer, show final
        localStorage.setItem(LS_TIMER_END, String(Date.now()));
        markLevelComplete(6);
        setTimeout(showFinal, 600);
      } else {
        document.getElementById('l6_bad').classList.remove('hidden');
      }
    }
  </script>
</body>
</html>